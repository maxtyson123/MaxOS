<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Max OS: /home/runner/work/MaxOS/MaxOS/kernel/src/drivers/ethernet/amd_am79c973.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Max OS
   &#160;<span id="projectnumber">0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('amd__am79c973_8cpp_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">amd_am79c973.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="amd__am79c973_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">//  Created by 98max on 22/10/2022.</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// </span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160; </div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="amd__am79c973_8h.html">drivers/ethernet/amd_am79c973.h</a>&gt;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacemaxOS.html">maxOS</a>;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacemaxOS_1_1common.html">maxOS::common</a>;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacemaxOS_1_1drivers.html">maxOS::drivers</a>;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacemaxOS_1_1drivers_1_1ethernet.html">maxOS::drivers::ethernet</a>;</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacemaxOS_1_1hardwarecommunication.html">maxOS::hardwarecommunication</a>;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160; </div>
<div class="line"><a name="l00013"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a9d91b4bc93271b315f6dd713fac388fe">   13</a></span>&#160;amd_am79c973::amd_am79c973(<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1PeripheralComponentInterconnectDeviceDescriptor.html">PeripheralComponentInterconnectDeviceDescriptor</a> *dev, <a class="code" href="classmaxOS_1_1hardwarecommunication_1_1InterruptManager.html">InterruptManager</a>* interrupts, <a class="code" href="classmaxOS_1_1common_1_1OutputStream.html">OutputStream</a> *amdNetMessageStream)</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        :   <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1EthernetDriver.html">EthernetDriver</a>(amdNetMessageStream),</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;            <a class="code" href="classmaxOS_1_1hardwarecommunication_1_1InterruptHandler.html">InterruptHandler</a>(dev -&gt; interrupt + interrupts-&gt;hardware_interrupt_offset(), interrupts),</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;            MACAddress0Port(dev -&gt;port_base),</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;            MACAddress2Port(dev -&gt;port_base + 0x02),</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;            MACAddress4Port(dev -&gt;port_base + 0x04),</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;            registerDataPort(dev -&gt;port_base + 0x10),</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;            registerAddressPort(dev -&gt;port_base + 0x12),</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;            busControlRegisterDataPort(dev -&gt;port_base + 0x16),</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;            resetPort(dev -&gt;port_base + 0x14)</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;{</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="comment">// No active buffer at the start</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    currentSendBuffer = 0;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    currentRecvBuffer = 0;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160; </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="comment">//Not active or intialized</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    active = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    initDone = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160; </div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <span class="comment">// Get the MAC adresses (split up in little endian order)</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;    uint64_t MAC0 = MACAddress0Port.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>() % 256;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    uint64_t MAC1 = MACAddress0Port.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>() / 256;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    uint64_t MAC2 = MACAddress2Port.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>() % 256;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    uint64_t MAC3 = MACAddress2Port.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>() / 256;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    uint64_t MAC4 = MACAddress4Port.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>() % 256;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    uint64_t MAC5 = MACAddress4Port.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>() / 256;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160; </div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <span class="comment">// Combine MAC addresses into one 48 bit number</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    ownMAC = MAC5 &lt;&lt; 40</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;             | MAC4 &lt;&lt; 32</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;             | MAC3 &lt;&lt; 24</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;             | MAC2 &lt;&lt; 16</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;             | MAC1 &lt;&lt; 8</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;             | MAC0;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">// Set the device to 32 bit mode</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(20);              <span class="comment">// Tell device to write to register 20</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    busControlRegisterDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0x102);    <span class="comment">// write desired data</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="comment">// Reset the stop bit (tell device it&#39;s not supposed to be reset now)</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0);               <span class="comment">// Tell device to write to register 0</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0x04);               <span class="comment">// write desired data</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="comment">// Set the initialization block</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    initBlock.mode = 0x0000;                         <span class="comment">// Promiscuous mode = false   ( promiscuous mode tells it to receive all packets, not just broadcasts and those for its own MAC address)</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    initBlock.reserved1 = 0;                         <span class="comment">// Reserved</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    initBlock.numSendBuffers = 3;                    <span class="comment">// Means 8 because 2^8 (number of bits used)</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    initBlock.reserved2 = 0;                         <span class="comment">// Reserved</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    initBlock.numRecvBuffers = 3;                    <span class="comment">// Means 8 because 2^8 (number of bits used)</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    initBlock.physicalAddress = ownMAC;              <span class="comment">// Set the physical address to the MAC address</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    initBlock.reserved3 = 0;                         <span class="comment">// Reserverd</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    initBlock.logicalAddress = 0;                    <span class="comment">// None for now</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160; </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="comment">// Set Buffer descriptors memory</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    sendBufferDescr = (BufferDescriptor*)((((uint32_t)&amp;sendBufferDescrMemory[0]) + 15) &amp; ~((uint32_t)0xF));</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    initBlock.sendBufferDescrAddress = (uint32_t)sendBufferDescr;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160; </div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    recvBufferDescr = (BufferDescriptor*)((((uint32_t)&amp;recvBufferDescrMemory[0]) + 15) &amp; ~((uint32_t)0xF));</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    initBlock.recvBufferDescrAddress = (uint32_t)recvBufferDescr;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; </div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">for</span>(uint8_t <a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a> = 0; <a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a> &lt; 8; <a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>++)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    {</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160; </div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        <span class="comment">// Send buffer descriptors</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        sendBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].address = (((uint32_t)&amp;sendBuffers[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>]) + 15 ) &amp; ~(uint32_t)0xF;       <span class="comment">// Same as above</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        sendBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].flags = 0x7FF                                                         <span class="comment">// Legnth of descriptor</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                                   | 0xF000;                                                     <span class="comment">// Set it to send buffer</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        sendBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].flags2 = 0;                                                           <span class="comment">// &quot;Flags2&quot; shows whether an error occurred while sending and should therefore be set to 0 by the drive</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        sendBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].avail = 0;                                                            <span class="comment">// IF it is in use</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160; </div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="comment">// Receive</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        recvBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].address = (((uint32_t)&amp;recvBuffers[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>]) + 15 ) &amp; ~(uint32_t)0xF;   <span class="comment">// Same as above</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        recvBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].flags = 0xF7FF                                                        <span class="comment">// Length of descriptor        (This 0xF7FF is what was causing the problem, it used to be 0x7FF)</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                                   | 0x80000000;                                                 <span class="comment">// Set it to receive buffer</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        recvBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].flags2 = 0;                                                           <span class="comment">// &quot;Flags2&quot; shows whether an error occurred while sending and should therefore be set to 0 by the drive</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        recvBufferDescr[<a class="code" href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">i</a>].avail = 0;                                                            <span class="comment">// IF it is in use</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    }</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">// Move initialization block into device</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(1);                                     <span class="comment">// Tell device to write to register 1</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>((uint32_t)(&amp;initBlock) &amp;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                           0xFFFF);             <span class="comment">// write address data</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(2);                                     <span class="comment">// Tell device to write to register 2</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(((uint32_t)(&amp;initBlock) &gt;&gt; 16) &amp;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                           0xFFFF);     <span class="comment">// write shifted address data</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160; </div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160; </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;}</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160; </div>
<div class="line"><a name="l00102"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#aacbc48386a4b5f36a63dc53b2f1bae2f">  102</a></span>&#160;<a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#aacbc48386a4b5f36a63dc53b2f1bae2f">amd_am79c973::~amd_am79c973</a>()</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;{</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;}</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160; </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00111"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#af343f26c6a53c4336c68103a7425ef15">  111</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#af343f26c6a53c4336c68103a7425ef15">amd_am79c973::activate</a>()</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;{</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160; </div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    initDone = <span class="keyword">false</span>;                                            <span class="comment">// Set initDone to false</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0);                           <span class="comment">// Tell device to write to register 0</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0x41);                           <span class="comment">// Enable Interrupts and start the device</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="keywordflow">while</span>(!initDone);                                            <span class="comment">// Wait for initDone to be set to true</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(4);                           <span class="comment">// Tell device to read from register 4</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    uint32_t temp = registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>();                     <span class="comment">// Get current data</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160; </div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(4);                           <span class="comment">// Tell device to write to register 4</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        temp |</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        0xC00);                   <span class="comment">// Bitwise OR function on data (This automatically enlarges packets smaller than 64 bytes to that size and removes some relatively superfluous information from received packets.)</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160; </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0);                           <span class="comment">// Tell device to write to register 0</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        0x42);                           <span class="comment">// Tell device that it is initialised and can begin operating</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160; </div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    active = <span class="keyword">true</span>;                                               <span class="comment">// Set active to true</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;}</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160; </div>
<div class="line"><a name="l00139"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#acf6d4a68e3e74a4b23d5811f536cf26f">  139</a></span>&#160;uint32_t <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#acf6d4a68e3e74a4b23d5811f536cf26f">amd_am79c973::reset</a>() {</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; </div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  resetPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>();</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    resetPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordflow">return</span> 10;                      <span class="comment">// 10 means wait for 10ms</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160; </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;}</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160; </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160; </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#ac925036cea408af2cd3d120c639985d2">  154</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#ac925036cea408af2cd3d120c639985d2">amd_am79c973::handle_interrupt</a>() {</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160; </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="comment">// Similar to PIC, data needs to be read when a interrupt is sent, or it hangs</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0);                           <span class="comment">// Tell device to read from register 0</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    uint32_t temp = registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">read</a>();                     <span class="comment">// Get current data</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160; </div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="comment">// Note: Cant be switch case as multiple errors can occur at the same time</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="comment">// Errors</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keywordflow">if</span>((temp &amp; 0x8000) == 0x8000)</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      <a class="code" href="classmaxOS_1_1drivers_1_1Driver.html#aceaadfd977efff51ee4e851e362b993a">error_message</a>(<span class="stringliteral">&quot;AMD am79c973 ERROR: &quot;</span>);</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keywordflow">if</span>((temp &amp; 0x2000) == 0x2000)</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <a class="code" href="classmaxOS_1_1drivers_1_1Driver.html#aceaadfd977efff51ee4e851e362b993a">error_message</a>(<span class="stringliteral">&quot;COLLISION ERROR\n&quot;</span>);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keywordflow">if</span>((temp &amp; 0x1000) == 0x1000)</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      <a class="code" href="classmaxOS_1_1drivers_1_1Driver.html#aceaadfd977efff51ee4e851e362b993a">error_message</a>(<span class="stringliteral">&quot;MISSED FRAME\n&quot;</span>);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">if</span>((temp &amp; 0x0800) == 0x0800)</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      <a class="code" href="classmaxOS_1_1drivers_1_1Driver.html#aceaadfd977efff51ee4e851e362b993a">error_message</a>(<span class="stringliteral">&quot;MEMORY ERROR\n&quot;</span>);</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; </div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160; </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="comment">// Responses</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordflow">if</span>((temp &amp; 0x0400) == 0x0400) FetchDataReceived();</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">if</span>((temp &amp; 0x0200) == 0x0200) FetchDataSent();</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="keywordflow">if</span>((temp &amp; 0x0100) == 0x0100) initDone = <span class="keyword">true</span>;<span class="comment">//</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160; </div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="comment">// Reply that it was received</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0);                           <span class="comment">// Tell device to write to register 0</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(temp);                           <span class="comment">// Tell device that the interrupt was received</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;}</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">// Sending a package :</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">// &quot;Flags2&quot; shows whether an error occurred while sending and should therefore be set to 0 by the driver.</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">//  The OWN bit must now be set in the “flags” field (0x80000000) in order to “transfer” the descriptor to the card.</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">//  Furthermore, STP (Start of Packet, 0x02000000) and ENP (End of Packet, 0x01000000) should be set - this indicates that the data is not split up, but that it is a single Ethernet packet.</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">//  Furthermore, bits 12-15 must be set (0x0000F000, are probably reserved) and bits 0-11 are negative Size of the package.</span></div>
<div class="line"><a name="l00197"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a47ce3c94382939df1c248c3a2ba206b6">  197</a></span>&#160;<span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a47ce3c94382939df1c248c3a2ba206b6">amd_am79c973::DoSend</a>(uint8_t *buffer, uint32_t <a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a>) {</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160; </div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keywordflow">while</span>(!active);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160; </div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordtype">int</span> sendDescriptor = currentSendBuffer;              <span class="comment">// Get where data has been written to</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    currentSendBuffer = (currentSendBuffer + 1) % 8;    <span class="comment">// Move send buffer to next send buffer (div by 8 so that it is cycled) (this allows for data to be sent from different m_tasks in parallel)</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160; </div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> &gt; 1518){                                    <span class="comment">// If attempt to send more than 1518 bytes at once it will be too large</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        <a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> = 1518;                                    <span class="comment">// Discard all data after that  (Generally if data is bigger than that at driver level then a higher up network layer must have made a mistake)</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160; </div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; </div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment">// What this loop does is copy the information passed as the parameter buffer (src) to the send buffer in the ram (dst) which the card will then use to send the data</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordflow">for</span> (uint8_t *src = buffer + <a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> -1,                                                   <span class="comment">// Set src pointer to the end of the data that is being sent</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;         *dst = (uint8_t*)(sendBufferDescr[sendDescriptor].address + <a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> -1);       <span class="comment">// Take the buffer that has been slected</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;         src &gt;= buffer;                                                             <span class="comment">// While there is still information in the buffer that hasnt been written to src</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;         src--,dst--                                                                <span class="comment">// Move 2 pointers to the end of the buffers</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;            )</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    {</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        *dst = *src;                                                                        <span class="comment">// Copy data from source buffer to destiantion buffer</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    }</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160; </div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160; </div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    sendBufferDescr[sendDescriptor].avail = 0;                               <span class="comment">// Set that this buffer is in use</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    sendBufferDescr[sendDescriptor].flags2 = 0;                              <span class="comment">// Clear any previous error messages</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    sendBufferDescr[sendDescriptor].flags = 0x8300F000                       <span class="comment">// Encode the size of what is being sent</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;                                            | ((uint16_t)((-<a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a>) &amp; 0xFFF));;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160; </div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    registerAddressPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(0);                           <span class="comment">// Tell device to write to register 0</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    registerDataPort.<a class="code" href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">write</a>(</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        0x48);                           <span class="comment">// Tell device to send the data currently in the buffer</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;}</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160; </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="keywordtype">void</span> amd_am79c973::FetchDataReceived()</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;{</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160; </div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">for</span>(;(recvBufferDescr[currentRecvBuffer].flags &amp; 0x80000000) == 0; currentRecvBuffer = (currentRecvBuffer+1)%8)         <span class="comment">//Loop through all the buffers</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    {</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <span class="keywordflow">if</span>(!(recvBufferDescr[currentRecvBuffer].<a class="code" href="amd__am79c973_8h.html#a773b39d480759f67926cb18ae2219281">flags</a>    &amp; 0x40000000)                   <span class="comment">//Check if there is an error</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;           &amp;&amp; (recvBufferDescr[currentRecvBuffer].flags &amp; 0x03000000) == 0x03000000)    <span class="comment">//Check start and end bits of the packet</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        {</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;            uint32_t <a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> = recvBufferDescr[currentRecvBuffer].flags2 &amp; 0xFFF;          <span class="comment">//Get the size of the packet</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> &gt; 64)                                                              <span class="comment">//If the size is the size of ethernet 2 frame</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                <a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a> -= 4;                                                              <span class="comment">//remove the checksum</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;            uint8_t* buffer = (uint8_t*)(recvBufferDescr[currentRecvBuffer].<a class="code" href="amd__am79c973_8h.html#ac0d31ca829f934cccd89f8054e02773e">address</a>);   <span class="comment">//Get the buffer</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1EthernetDriver.html#ac859773753c9aa3b3cc53836bf9f2410">FireDataReceived</a>(buffer, <a class="code" href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a>);                                             <span class="comment">//Pass data to handler</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        }</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; </div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        recvBufferDescr[currentRecvBuffer].flags2 = 0;                                  <span class="comment">//write that the data has been read and can now be used again</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        recvBufferDescr[currentRecvBuffer].flags = 0x8000F7FF;                          <span class="comment">//Clear the buffer</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    }</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;}</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keywordtype">void</span> amd_am79c973::FetchDataSent()</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;{</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160; </div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">    for(;(recvBufferDescr[currentRecvBuffer].flags &amp; 0x80000000) == 0; currentRecvBuffer = (currentRecvBuffer+1)%8)</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">        if(!(recvBufferDescr[currentRecvBuffer].flags    &amp; 0x40000000)</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">           &amp;&amp; (recvBufferDescr[currentRecvBuffer].flags &amp; 0x03000000) == 0x03000000)</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">        {</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">            uint32_t size = recvBufferDescr[currentRecvBuffer].flags2 &amp; 0xFFF;</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">            if (size &gt; 64)</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">                size -= 4;</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">            uint8_t* buffer = (uint8_t*)(recvBufferDescr[currentRecvBuffer].address);</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">            FireDataSent(buffer, size);</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">        recvBufferDescr[currentRecvBuffer].flags2 = 0;</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">        recvBufferDescr[currentRecvBuffer].flags = 0x8000F7FF;</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; </div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;}</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; </div>
<div class="line"><a name="l00281"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#acd69d1f0897713631d40cf073926fed7">  281</a></span>&#160;uint64_t <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#acd69d1f0897713631d40cf073926fed7">amd_am79c973::GetMediaAccessControlAddress</a>() {</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    <span class="keywordflow">while</span>(ownMAC == 0);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">return</span> ownMAC;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;}</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160; </div>
<div class="line"><a name="l00286"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a087d7785cb300529b700522460a62751">  286</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a087d7785cb300529b700522460a62751">amd_am79c973::deactivate</a>() {</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160; </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;}</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160; </div>
<div class="line"><a name="l00290"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a013e544525f4aef5a4dc3aa7b0a682c2">  290</a></span>&#160;<span class="keywordtype">string</span> <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a013e544525f4aef5a4dc3aa7b0a682c2">amd_am79c973::get_vendor_name</a>() {</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;AMD&quot;</span>;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;}</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160; </div>
<div class="line"><a name="l00294"></a><span class="lineno"><a class="line" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a177e151fa19903dc2c733664883ac603">  294</a></span>&#160;<span class="keywordtype">string</span> <a class="code" href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a177e151fa19903dc2c733664883ac603">amd_am79c973::get_device_name</a>() {</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="keywordflow">return</span> <span class="stringliteral">&quot;PCnet-Fast III (Am79C973)&quot;</span>;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;}</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160; </div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_acd69d1f0897713631d40cf073926fed7"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#acd69d1f0897713631d40cf073926fed7">maxOS::drivers::ethernet::amd_am79c973::GetMediaAccessControlAddress</a></div><div class="ttdeci">uint64_t GetMediaAccessControlAddress()</div><div class="ttdoc">This function gets the MAC address.</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00281">amd_am79c973.cpp:281</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1hardwarecommunication_1_1InterruptManager_html"><div class="ttname"><a href="classmaxOS_1_1hardwarecommunication_1_1InterruptManager.html">maxOS::hardwarecommunication::InterruptManager</a></div><div class="ttdoc">Handles all interrupts and passes them to the correct handler.</div><div class="ttdef"><b>Definition:</b> <a href="interrupts_8h_source.html#l00063">interrupts.h:63</a></div></div>
<div class="ttc" id="afat32_8h_html_ab2c6b258f02add8fdf4cfc7c371dd772"><div class="ttname"><a href="fat32_8h.html#ab2c6b258f02add8fdf4cfc7c371dd772">size</a></div><div class="ttdeci">uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="fat32_8h_source.html#l00020">fat32.h:20</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1hardwarecommunication_1_1Port16Bit_html_a24f6a288e57d4c01634926ca3580324d"><div class="ttname"><a href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a24f6a288e57d4c01634926ca3580324d">maxOS::hardwarecommunication::Port16Bit::write</a></div><div class="ttdeci">virtual void write(uint16_t data)</div><div class="ttdoc">write a word to the port</div><div class="ttdef"><b>Definition:</b> <a href="port_8cpp_source.html#l00080">port.cpp:80</a></div></div>
<div class="ttc" id="anamespacemaxOS_1_1hardwarecommunication_html"><div class="ttname"><a href="namespacemaxOS_1_1hardwarecommunication.html">maxOS::hardwarecommunication</a></div><div class="ttdef"><b>Definition:</b> <a href="interrupts_8h_source.html#l00017">interrupts.h:17</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_acf6d4a68e3e74a4b23d5811f536cf26f"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#acf6d4a68e3e74a4b23d5811f536cf26f">maxOS::drivers::ethernet::amd_am79c973::reset</a></div><div class="ttdeci">uint32_t reset()</div><div class="ttdoc">This function resets the device.</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00139">amd_am79c973.cpp:139</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1hardwarecommunication_1_1InterruptHandler_html"><div class="ttname"><a href="classmaxOS_1_1hardwarecommunication_1_1InterruptHandler.html">maxOS::hardwarecommunication::InterruptHandler</a></div><div class="ttdoc">Handles a certain interrupt number.</div><div class="ttdef"><b>Definition:</b> <a href="interrupts_8h_source.html#l00025">interrupts.h:25</a></div></div>
<div class="ttc" id="aamd__am79c973_8h_html"><div class="ttname"><a href="amd__am79c973_8h.html">amd_am79c973.h</a></div></div>
<div class="ttc" id="aamd__am79c973_8h_html_a773b39d480759f67926cb18ae2219281"><div class="ttname"><a href="amd__am79c973_8h.html#a773b39d480759f67926cb18ae2219281">flags</a></div><div class="ttdeci">uint32_t flags</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8h_source.html#l00004">amd_am79c973.h:4</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_a47ce3c94382939df1c248c3a2ba206b6"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a47ce3c94382939df1c248c3a2ba206b6">maxOS::drivers::ethernet::amd_am79c973::DoSend</a></div><div class="ttdeci">void DoSend(uint8_t *buffer, uint32_t size)</div><div class="ttdoc">This function sends a package.</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00197">amd_am79c973.cpp:197</a></div></div>
<div class="ttc" id="anamespacemaxOS_1_1drivers_html"><div class="ttname"><a href="namespacemaxOS_1_1drivers.html">maxOS::drivers</a></div><div class="ttdef"><b>Definition:</b> <a href="clock_8h_source.html#l00017">clock.h:17</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1Driver_html_aceaadfd977efff51ee4e851e362b993a"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1Driver.html#aceaadfd977efff51ee4e851e362b993a">maxOS::drivers::Driver::error_message</a></div><div class="ttdeci">void error_message(string message)</div><div class="ttdoc">write a message to the driver message stream if it is not null</div><div class="ttdef"><b>Definition:</b> <a href="driver_8cpp_source.html#l00055">driver.cpp:55</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_ac925036cea408af2cd3d120c639985d2"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#ac925036cea408af2cd3d120c639985d2">maxOS::drivers::ethernet::amd_am79c973::handle_interrupt</a></div><div class="ttdeci">void handle_interrupt()</div><div class="ttdoc">This function handles the interrupt for the device.</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00154">amd_am79c973.cpp:154</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_a177e151fa19903dc2c733664883ac603"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a177e151fa19903dc2c733664883ac603">maxOS::drivers::ethernet::amd_am79c973::get_device_name</a></div><div class="ttdeci">string get_device_name()</div><div class="ttdoc">Get the device name of the driver.</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00294">amd_am79c973.cpp:294</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1EthernetDriver_html_ac859773753c9aa3b3cc53836bf9f2410"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1EthernetDriver.html#ac859773753c9aa3b3cc53836bf9f2410">maxOS::drivers::ethernet::EthernetDriver::FireDataReceived</a></div><div class="ttdeci">void FireDataReceived(uint8_t *buffer, uint32_t size)</div><div class="ttdoc">Handle the recieved data.</div><div class="ttdef"><b>Definition:</b> <a href="ethernet_8cpp_source.html#l00120">ethernet.cpp:120</a></div></div>
<div class="ttc" id="anamespacemaxOS_1_1drivers_1_1peripherals_html_a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0"><div class="ttname"><a href="namespacemaxOS_1_1drivers_1_1peripherals.html#a9854b786a692cef8357e51059ed90ab4a45ce6c8daf3081e4b64797e319378cb0">maxOS::drivers::peripherals::i</a></div><div class="ttdeci">@ i</div><div class="ttdef"><b>Definition:</b> <a href="keyboard_8h_source.html#l00035">keyboard.h:35</a></div></div>
<div class="ttc" id="aamd__am79c973_8h_html_ac0d31ca829f934cccd89f8054e02773e"><div class="ttname"><a href="amd__am79c973_8h.html#ac0d31ca829f934cccd89f8054e02773e">address</a></div><div class="ttdeci">uint32_t address</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8h_source.html#l00003">amd_am79c973.h:3</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1common_1_1OutputStream_html"><div class="ttname"><a href="classmaxOS_1_1common_1_1OutputStream.html">maxOS::common::OutputStream</a></div><div class="ttdoc">A stream that strings can be written to.</div><div class="ttdef"><b>Definition:</b> <a href="outputStream_8h_source.html#l00041">outputStream.h:41</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_a087d7785cb300529b700522460a62751"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a087d7785cb300529b700522460a62751">maxOS::drivers::ethernet::amd_am79c973::deactivate</a></div><div class="ttdeci">void deactivate()</div><div class="ttdoc">deactivate the driver</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00286">amd_am79c973.cpp:286</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_af343f26c6a53c4336c68103a7425ef15"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#af343f26c6a53c4336c68103a7425ef15">maxOS::drivers::ethernet::amd_am79c973::activate</a></div><div class="ttdeci">void activate()</div><div class="ttdoc">This function activates the device and starts it (Runs when the driver-manger calls activateAll())</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00111">amd_am79c973.cpp:111</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1hardwarecommunication_1_1PeripheralComponentInterconnectDeviceDescriptor_html"><div class="ttname"><a href="classmaxOS_1_1hardwarecommunication_1_1PeripheralComponentInterconnectDeviceDescriptor.html">maxOS::hardwarecommunication::PeripheralComponentInterconnectDeviceDescriptor</a></div><div class="ttdoc">Stores information about a PCI device.</div><div class="ttdef"><b>Definition:</b> <a href="pci_8h_source.html#l00043">pci.h:43</a></div></div>
<div class="ttc" id="anamespacemaxOS_1_1drivers_1_1ethernet_html"><div class="ttname"><a href="namespacemaxOS_1_1drivers_1_1ethernet.html">maxOS::drivers::ethernet</a></div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8h_source.html#l00019">amd_am79c973.h:19</a></div></div>
<div class="ttc" id="anamespacemaxOS_html"><div class="ttname"><a href="namespacemaxOS.html">maxOS</a></div><div class="ttdef"><b>Definition:</b> <a href="colour_8h_source.html#l00010">colour.h:10</a></div></div>
<div class="ttc" id="anamespacemaxOS_1_1common_html"><div class="ttname"><a href="namespacemaxOS_1_1common.html">maxOS::common</a></div><div class="ttdef"><b>Definition:</b> <a href="colour_8h_source.html#l00012">colour.h:12</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_a013e544525f4aef5a4dc3aa7b0a682c2"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#a013e544525f4aef5a4dc3aa7b0a682c2">maxOS::drivers::ethernet::amd_am79c973::get_vendor_name</a></div><div class="ttdeci">string get_vendor_name()</div><div class="ttdoc">Get the vendor name of the driver.</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00290">amd_am79c973.cpp:290</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1EthernetDriver_html"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1EthernetDriver.html">maxOS::drivers::ethernet::EthernetDriver</a></div><div class="ttdoc">Driver for the Ethernet Controller, manages the sending and receiving of data, the mac address,...</div><div class="ttdef"><b>Definition:</b> <a href="ethernet_8h_source.html#l00085">ethernet.h:85</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1hardwarecommunication_1_1Port16Bit_html_a5147c7c28ca813536015969ae6ba6bb6"><div class="ttname"><a href="classmaxOS_1_1hardwarecommunication_1_1Port16Bit.html#a5147c7c28ca813536015969ae6ba6bb6">maxOS::hardwarecommunication::Port16Bit::read</a></div><div class="ttdeci">virtual uint16_t read()</div><div class="ttdoc">read a word from the port</div><div class="ttdef"><b>Definition:</b> <a href="port_8cpp_source.html#l00089">port.cpp:89</a></div></div>
<div class="ttc" id="aclassmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973_html_aacbc48386a4b5f36a63dc53b2f1bae2f"><div class="ttname"><a href="classmaxOS_1_1drivers_1_1ethernet_1_1amd__am79c973.html#aacbc48386a4b5f36a63dc53b2f1bae2f">maxOS::drivers::ethernet::amd_am79c973::~amd_am79c973</a></div><div class="ttdeci">~amd_am79c973()</div><div class="ttdef"><b>Definition:</b> <a href="amd__am79c973_8cpp_source.html#l00102">amd_am79c973.cpp:102</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_dc43877d82dd332f9fb2071fcca799d6.html">kernel</a></li><li class="navelem"><a class="el" href="dir_3dd30a497388ee684638f120a124721c.html">src</a></li><li class="navelem"><a class="el" href="dir_79cdf04718782f286da113044bf76c98.html">drivers</a></li><li class="navelem"><a class="el" href="dir_efcb6c0e12d9cee5df1accc0ecb8fd49.html">ethernet</a></li><li class="navelem"><a class="el" href="amd__am79c973_8cpp.html">amd_am79c973.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
