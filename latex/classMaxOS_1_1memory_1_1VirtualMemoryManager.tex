\hypertarget{classMaxOS_1_1memory_1_1VirtualMemoryManager}{}\doxysection{Max\+OS\+::memory\+::Virtual\+Memory\+Manager Class Reference}
\label{classMaxOS_1_1memory_1_1VirtualMemoryManager}\index{MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}}


{\ttfamily \#include $<$virtual.\+h$>$}

\doxysubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classMaxOS_1_1memory_1_1VirtualMemoryManager_a89f26f978695bfe043afd51b4388b323}{Virtual\+Memory\+Manager}} (bool is\+\_\+kernel)
\item 
\mbox{\hyperlink{classMaxOS_1_1memory_1_1VirtualMemoryManager_a77e2717ead1bd12e12da9c824b0c7921}{$\sim$\+Virtual\+Memory\+Manager}} ()
\item 
void $\ast$ \mbox{\hyperlink{classMaxOS_1_1memory_1_1VirtualMemoryManager_a433396979e1b088454eefbce0964b709}{allocate}} (size\+\_\+t \mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}}, size\+\_\+t \mbox{\hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags}})
\begin{DoxyCompactList}\small\item\em Allocate a new chunk of virtual memory. \end{DoxyCompactList}\item 
void $\ast$ \mbox{\hyperlink{classMaxOS_1_1memory_1_1VirtualMemoryManager_a4c1a63b53f6acbba12095a1a13fc0ecf}{allocate}} (uint64\+\_\+t \mbox{\hyperlink{gdt_8h_ab6b52376c1b9d81e6ea6f95a1225f832}{address}}, size\+\_\+t \mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}}, size\+\_\+t \mbox{\hyperlink{tcp_8h_aa2585d779da0ab21273a8d92de9a0ebe}{flags}})
\begin{DoxyCompactList}\small\item\em Allocate a new chunk of virtual memory at a specific address (ie for mmap io devices) \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classMaxOS_1_1memory_1_1VirtualMemoryManager_a96b3efdb246def1b85d311a61e401af6}{free}} (void $\ast$\mbox{\hyperlink{gdt_8h_ab6b52376c1b9d81e6ea6f95a1225f832}{address}})
\begin{DoxyCompactList}\small\item\em Free a chunk of virtual memory. \end{DoxyCompactList}\item 
size\+\_\+t \mbox{\hyperlink{classMaxOS_1_1memory_1_1VirtualMemoryManager_a4ae320422dd476cfbf63d810fc725bd5}{memory\+\_\+used}} ()
\begin{DoxyCompactList}\small\item\em Returns the amount of memory used. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}


Definition at line 35 of file virtual.\+h.



\doxysubsection{Constructor \& Destructor Documentation}
\mbox{\Hypertarget{classMaxOS_1_1memory_1_1VirtualMemoryManager_a89f26f978695bfe043afd51b4388b323}\label{classMaxOS_1_1memory_1_1VirtualMemoryManager_a89f26f978695bfe043afd51b4388b323}} 
\index{MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}!VirtualMemoryManager@{VirtualMemoryManager}}
\index{VirtualMemoryManager@{VirtualMemoryManager}!MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}}
\doxysubsubsection{\texorpdfstring{VirtualMemoryManager()}{VirtualMemoryManager()}}
{\footnotesize\ttfamily Virtual\+Memory\+Manager\+::\+Virtual\+Memory\+Manager (\begin{DoxyParamCaption}\item[{bool}]{is\+\_\+kernel }\end{DoxyParamCaption})}



Definition at line 11 of file virtual.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{12 : m\_physical\_memory\_manager(\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_a1d6ffacb7290c01505c3dec9f9cfd3f1}{PhysicalMemoryManager::s\_current\_manager}}),}
\DoxyCodeLine{13   m\_is\_kernel(is\_kernel)}
\DoxyCodeLine{14 \{}
\DoxyCodeLine{15 }
\DoxyCodeLine{16     \textcolor{comment}{// If not the kernel, we need to allocate a new PML4 table}}
\DoxyCodeLine{17     \textcolor{keywordflow}{if}(!m\_is\_kernel)\{}
\DoxyCodeLine{18 }
\DoxyCodeLine{19       \textcolor{comment}{// Get a new pml4 table}}
\DoxyCodeLine{20       m\_pml4\_root\_physical\_address = (uint64\_t*)m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afbe57cbd6b31ef26b53176f0fd0fc8fe}{allocate\_frame}}();}
\DoxyCodeLine{21       m\_pml4\_root\_address = (uint64\_t*)\mbox{\hyperlink{classMaxOS_1_1memory_1_1MemoryManager_ab093d27663b4911c7995f36945ccd1e9}{MemoryManager::to\_dm\_region}}((uint64\_t)m\_pml4\_root\_physical\_address);}
\DoxyCodeLine{22       \mbox{\hyperlink{kprint_8h_ad0dbdc0814f8a967875ad592df02a663}{\_kprintf}}(\textcolor{stringliteral}{"Allocated new PML4 table at: 0x\%x\(\backslash\)n"}, m\_pml4\_root\_address);}
\DoxyCodeLine{23 }
\DoxyCodeLine{24       \textcolor{comment}{// Clear the table}}
\DoxyCodeLine{25       m\_physical\_memory\_manager -\/> clean\_page\_table(m\_pml4\_root\_address);}
\DoxyCodeLine{26 }
\DoxyCodeLine{27       \textcolor{comment}{// Map the higher half of the kernel (p4 256 -\/ 511)}}
\DoxyCodeLine{28       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} = 256; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} < 512; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}++)\{}
\DoxyCodeLine{29 }
\DoxyCodeLine{30         \textcolor{comment}{// Recursive Map the pml4 table (so that we can access the new pml4 table later on)}}
\DoxyCodeLine{31         \textcolor{keywordflow}{if}(\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} == 510) \{}
\DoxyCodeLine{32           m\_pml4\_root\_address[\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}] = (uint64\_t)m\_pml4\_root\_physical\_address | \mbox{\hyperlink{namespaceMaxOS_1_1memory_ae0e83b5743a37b4d0d2a93bb3bbe84eba980a5bc5e6393398f4e52e1c27bdd382}{Present}} | \mbox{\hyperlink{namespaceMaxOS_1_1memory_ae0e83b5743a37b4d0d2a93bb3bbe84ebabc3cb78aef6a50841121fd08c2a49151}{Write}};}
\DoxyCodeLine{33           \textcolor{keywordflow}{continue};}
\DoxyCodeLine{34         \}}
\DoxyCodeLine{35 }
\DoxyCodeLine{36         \textcolor{comment}{// Set the new pml4 table to the old (kernel) pml4 table}}
\DoxyCodeLine{37         m\_pml4\_root\_address[\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}] = m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_ac54f576d801ed62713b84ae64d83fb64}{get\_pml4\_root\_address}}()[\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}];}
\DoxyCodeLine{38 }
\DoxyCodeLine{39       \}}
\DoxyCodeLine{40       \mbox{\hyperlink{kprint_8h_ad0dbdc0814f8a967875ad592df02a663}{\_kprintf}}(\textcolor{stringliteral}{"Mapped higher half of kernel\(\backslash\)n"});}
\DoxyCodeLine{41 }
\DoxyCodeLine{42 }
\DoxyCodeLine{43     \}\textcolor{keywordflow}{else}\{}
\DoxyCodeLine{44       m\_pml4\_root\_address = m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_ac54f576d801ed62713b84ae64d83fb64}{get\_pml4\_root\_address}}();}
\DoxyCodeLine{45     \};}
\DoxyCodeLine{46 }
\DoxyCodeLine{47     \textcolor{comment}{// Space to store VMM chunks}}
\DoxyCodeLine{48     uint64\_t vmm\_space = \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_a5caa4d8e8944cd72c5a01635b056be9c}{PhysicalMemoryManager::align\_to\_page}}(\mbox{\hyperlink{classMaxOS_1_1memory_1_1MemoryManager_a25fe2fa3e01b0a9593cede08126095bf}{MemoryManager::s\_hh\_direct\_map\_offset}} + m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_a0bd4c0766bc4c3930920814f2f7de1c5}{get\_memory\_size}}() + \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afe7fbedb30365ee050a210d4854a15b8}{PhysicalMemoryManager::s\_page\_size}});}
\DoxyCodeLine{49     m\_first\_region = (virtual\_memory\_region\_t*)vmm\_space;}
\DoxyCodeLine{50     m\_current\_region = m\_first\_region;}
\DoxyCodeLine{51 }
\DoxyCodeLine{52     \textcolor{comment}{// Allocate space for the vmm}}
\DoxyCodeLine{53     \textcolor{keywordtype}{void}* vmm\_space\_physical = m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afbe57cbd6b31ef26b53176f0fd0fc8fe}{allocate\_frame}}();}
\DoxyCodeLine{54     \mbox{\hyperlink{kprint_8h_adf7b5d69e4c25995b3211b91b27f33b6}{ASSERT}}(vmm\_space\_physical != \textcolor{keyword}{nullptr}, \textcolor{stringliteral}{"Failed to allocate VMM space"});}
\DoxyCodeLine{55     m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_a732ea9bd93397bbddd596bee127ac8f3}{map}}(vmm\_space\_physical, (\mbox{\hyperlink{namespaceMaxOS_1_1memory_a1a4a2cf740017bbb681bbe110a18fdcb}{virtual\_address\_t}}*)vmm\_space, \mbox{\hyperlink{namespaceMaxOS_1_1memory_ae0e83b5743a37b4d0d2a93bb3bbe84eba980a5bc5e6393398f4e52e1c27bdd382}{Present}} | \mbox{\hyperlink{namespaceMaxOS_1_1memory_ae0e83b5743a37b4d0d2a93bb3bbe84ebabc3cb78aef6a50841121fd08c2a49151}{Write}}, m\_pml4\_root\_address);}
\DoxyCodeLine{56     m\_first\_region-\/>next = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{57     \mbox{\hyperlink{kprint_8h_ad0dbdc0814f8a967875ad592df02a663}{\_kprintf}}(\textcolor{stringliteral}{"Allocated VMM: physical: 0x\%x, virtual: 0x\%x\(\backslash\)n"}, vmm\_space\_physical, vmm\_space);}
\DoxyCodeLine{58 }
\DoxyCodeLine{59     \textcolor{comment}{// Calculate the next available address}}
\DoxyCodeLine{60     m\_next\_available\_address = \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afe7fbedb30365ee050a210d4854a15b8}{PhysicalMemoryManager::s\_page\_size}};}
\DoxyCodeLine{61     \textcolor{keywordflow}{if}(m\_is\_kernel)\{}
\DoxyCodeLine{62 }
\DoxyCodeLine{63       \textcolor{comment}{// Kernel needs to start at the higher half}}
\DoxyCodeLine{64       m\_next\_available\_address += vmm\_space + s\_reserved\_space;}
\DoxyCodeLine{65 }
\DoxyCodeLine{66     \}}
\DoxyCodeLine{67     \mbox{\hyperlink{kprint_8h_ad0dbdc0814f8a967875ad592df02a663}{\_kprintf}}(\textcolor{stringliteral}{"Next available address: 0x\%x\(\backslash\)n"}, m\_next\_available\_address);}
\DoxyCodeLine{68 }
\DoxyCodeLine{69 }
\DoxyCodeLine{70 \}}

\end{DoxyCode}


References \+\_\+kprintf, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::align\+\_\+to\+\_\+page(), Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::allocate\+\_\+frame(), A\+S\+S\+E\+RT, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::get\+\_\+memory\+\_\+size(), Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::get\+\_\+pml4\+\_\+root\+\_\+address(), Max\+O\+S\+::drivers\+::peripherals\+::i, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::map(), Max\+O\+S\+::memory\+::\+Present, Max\+O\+S\+::memory\+::\+Memory\+Manager\+::s\+\_\+hh\+\_\+direct\+\_\+map\+\_\+offset, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::s\+\_\+page\+\_\+size, Max\+O\+S\+::memory\+::\+Memory\+Manager\+::to\+\_\+dm\+\_\+region(), and Max\+O\+S\+::memory\+::\+Write.

\mbox{\Hypertarget{classMaxOS_1_1memory_1_1VirtualMemoryManager_a77e2717ead1bd12e12da9c824b0c7921}\label{classMaxOS_1_1memory_1_1VirtualMemoryManager_a77e2717ead1bd12e12da9c824b0c7921}} 
\index{MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}!````~VirtualMemoryManager@{$\sim$VirtualMemoryManager}}
\index{````~VirtualMemoryManager@{$\sim$VirtualMemoryManager}!MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}}
\doxysubsubsection{\texorpdfstring{$\sim$VirtualMemoryManager()}{~VirtualMemoryManager()}}
{\footnotesize\ttfamily Virtual\+Memory\+Manager\+::$\sim$\+Virtual\+Memory\+Manager (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Definition at line 72 of file virtual.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{72                                             \{}
\DoxyCodeLine{73 }
\DoxyCodeLine{74 \}}

\end{DoxyCode}


\doxysubsection{Member Function Documentation}
\mbox{\Hypertarget{classMaxOS_1_1memory_1_1VirtualMemoryManager_a433396979e1b088454eefbce0964b709}\label{classMaxOS_1_1memory_1_1VirtualMemoryManager_a433396979e1b088454eefbce0964b709}} 
\index{MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}!allocate@{allocate}}
\index{allocate@{allocate}!MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}}
\doxysubsubsection{\texorpdfstring{allocate()}{allocate()}\hspace{0.1cm}{\footnotesize\ttfamily [1/2]}}
{\footnotesize\ttfamily void $\ast$ Virtual\+Memory\+Manager\+::allocate (\begin{DoxyParamCaption}\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t}]{flags }\end{DoxyParamCaption})}



Allocate a new chunk of virtual memory. 


\begin{DoxyParams}{Parameters}
{\em size} & The size of the memory to allocate \\
\hline
{\em flags} & The flags to set on the memory \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The address of the allocated memory 
\end{DoxyReturn}


Definition at line 83 of file virtual.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{83                                                               \{}
\DoxyCodeLine{84   \textcolor{keywordflow}{return} \mbox{\hyperlink{classMaxOS_1_1memory_1_1VirtualMemoryManager_a433396979e1b088454eefbce0964b709}{allocate}}(0, \mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}}, \mbox{\hyperlink{amd__am79c973_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags}});}
\DoxyCodeLine{85 \}}

\end{DoxyCode}


References flags, and size.



Referenced by Max\+O\+S\+::memory\+::\+Memory\+Manager\+::\+Memory\+Manager().

\mbox{\Hypertarget{classMaxOS_1_1memory_1_1VirtualMemoryManager_a4c1a63b53f6acbba12095a1a13fc0ecf}\label{classMaxOS_1_1memory_1_1VirtualMemoryManager_a4c1a63b53f6acbba12095a1a13fc0ecf}} 
\index{MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}!allocate@{allocate}}
\index{allocate@{allocate}!MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}}
\doxysubsubsection{\texorpdfstring{allocate()}{allocate()}\hspace{0.1cm}{\footnotesize\ttfamily [2/2]}}
{\footnotesize\ttfamily void $\ast$ Virtual\+Memory\+Manager\+::allocate (\begin{DoxyParamCaption}\item[{uint64\+\_\+t}]{address,  }\item[{size\+\_\+t}]{size,  }\item[{size\+\_\+t}]{flags }\end{DoxyParamCaption})}



Allocate a new chunk of virtual memory at a specific address (ie for mmap io devices) 


\begin{DoxyParams}{Parameters}
{\em address} & The address to allocate at \\
\hline
{\em size} & The size of the memory to allocate \\
\hline
{\em flags} & The flags to set on the memory \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The address of the allocated memory or nullptr if failed 
\end{DoxyReturn}


Definition at line 95 of file virtual.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{95                                                                                 \{}
\DoxyCodeLine{96 }
\DoxyCodeLine{97   \textcolor{comment}{// Make sure allocating something}}
\DoxyCodeLine{98   \textcolor{keywordflow}{if}(\mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}} == 0)}
\DoxyCodeLine{99     \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};}
\DoxyCodeLine{100 }
\DoxyCodeLine{101   \textcolor{comment}{// If specific address is given}}
\DoxyCodeLine{102   \textcolor{keywordflow}{if}(\mbox{\hyperlink{amd__am79c973_8h_ac0d31ca829f934cccd89f8054e02773e}{address}} != 0)\{}
\DoxyCodeLine{103 }
\DoxyCodeLine{104       \textcolor{comment}{// Make sure isnt already allocated}}
\DoxyCodeLine{105       \textcolor{keywordflow}{if}(\mbox{\hyperlink{amd__am79c973_8h_ac0d31ca829f934cccd89f8054e02773e}{address}} < m\_next\_available\_address)}
\DoxyCodeLine{106         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};}
\DoxyCodeLine{107 }
\DoxyCodeLine{108       \textcolor{comment}{// Make sure its aligned}}
\DoxyCodeLine{109       \textcolor{keywordflow}{if}(!\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_aa7f389d1b15d109bd5669d0475ebc912}{PhysicalMemoryManager::check\_aligned}}(\mbox{\hyperlink{amd__am79c973_8h_ac0d31ca829f934cccd89f8054e02773e}{address}}))}
\DoxyCodeLine{110         \textcolor{keywordflow}{return} \textcolor{keyword}{nullptr};}
\DoxyCodeLine{111 }
\DoxyCodeLine{112   \}}
\DoxyCodeLine{113 }
\DoxyCodeLine{114   \textcolor{comment}{// Make sure the size is aligned}}
\DoxyCodeLine{115   \mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}} = \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_ab9f9868ea17c935bf249e47371e97fb5}{PhysicalMemoryManager::align\_up\_to\_page}}(\mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}}, \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afe7fbedb30365ee050a210d4854a15b8}{PhysicalMemoryManager::s\_page\_size}});}
\DoxyCodeLine{116 }
\DoxyCodeLine{117   \textcolor{comment}{// Is there space in the current region}}
\DoxyCodeLine{118   \textcolor{keywordflow}{if}(m\_current\_chunk >= s\_chunks\_per\_page)}
\DoxyCodeLine{119     new\_region();}
\DoxyCodeLine{120 }
\DoxyCodeLine{121   \textcolor{comment}{// If we need to allocate at a specific address}}
\DoxyCodeLine{122   \textcolor{keywordflow}{if}(\mbox{\hyperlink{amd__am79c973_8h_ac0d31ca829f934cccd89f8054e02773e}{address}} != 0)\{}
\DoxyCodeLine{123     m\_next\_available\_address = \mbox{\hyperlink{amd__am79c973_8h_ac0d31ca829f934cccd89f8054e02773e}{address}};    \textcolor{comment}{//TODO: Creates mem fragmentation -\/ fix}}
\DoxyCodeLine{124   \}}
\DoxyCodeLine{125 }
\DoxyCodeLine{126   \textcolor{comment}{// Allocate the memory}}
\DoxyCodeLine{127   \mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk}{virtual\_memory\_chunk\_t}}* chunk = \&m\_current\_region-\/>chunks[m\_current\_chunk];}
\DoxyCodeLine{128   chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa801ec740419740a3d9576bcdf821930}{size}} = \mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}};}
\DoxyCodeLine{129   chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_a3197fff13af0c0c20e83ad26c4e5d6f6}{flags}} = \mbox{\hyperlink{amd__am79c973_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags}};}
\DoxyCodeLine{130   chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa470b01af19e3aaeb7505cdd0b5ad647}{start\_address}} = m\_next\_available\_address;}
\DoxyCodeLine{131 }
\DoxyCodeLine{132   \textcolor{comment}{// Update the next available address}}
\DoxyCodeLine{133   m\_next\_available\_address += \mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}};}
\DoxyCodeLine{134   m\_current\_chunk++;}
\DoxyCodeLine{135 }
\DoxyCodeLine{136   \textcolor{comment}{// If just reserving the space don't map it}}
\DoxyCodeLine{137   \textcolor{keywordflow}{if}(\mbox{\hyperlink{amd__am79c973_8h_a1e87af3c18a2fd36c61faf89949bdc3f}{flags}} \& \mbox{\hyperlink{namespaceMaxOS_1_1memory_a12ca8e10f17e52d8375319daaaf6f380a5379a330d2ed6de35d3e88ff46a14731}{Reserve}})}
\DoxyCodeLine{138     \textcolor{keywordflow}{return} (\textcolor{keywordtype}{void}*)chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa470b01af19e3aaeb7505cdd0b5ad647}{start\_address}};}
\DoxyCodeLine{139 }
\DoxyCodeLine{140   \textcolor{comment}{// Map the memory}}
\DoxyCodeLine{141   \textcolor{keywordtype}{size\_t} pages = \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_ad09e22d0fe86e952a3eb92718fcd3c32}{PhysicalMemoryManager::size\_to\_frames}}(\mbox{\hyperlink{fat32_8h_ab2c6b258f02add8fdf4cfc7c371dd772}{size}});}
\DoxyCodeLine{142   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} = 0; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} < pages; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}++)\{}
\DoxyCodeLine{143 }
\DoxyCodeLine{144     \textcolor{comment}{// Allocate a new frame}}
\DoxyCodeLine{145     \mbox{\hyperlink{namespaceMaxOS_1_1memory_a86d1744b2aea4590cf02ef32ff8acc63}{physical\_address\_t}}* frame = m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afbe57cbd6b31ef26b53176f0fd0fc8fe}{allocate\_frame}}();}
\DoxyCodeLine{146     \mbox{\hyperlink{kprint_8h_adf7b5d69e4c25995b3211b91b27f33b6}{ASSERT}}(frame != \textcolor{keyword}{nullptr}, \textcolor{stringliteral}{"Failed to allocate frame"});}
\DoxyCodeLine{147 }
\DoxyCodeLine{148     \textcolor{comment}{// Map the frame}}
\DoxyCodeLine{149     m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_a732ea9bd93397bbddd596bee127ac8f3}{map}}(frame, (\mbox{\hyperlink{namespaceMaxOS_1_1memory_a1a4a2cf740017bbb681bbe110a18fdcb}{virtual\_address\_t}}*)chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa470b01af19e3aaeb7505cdd0b5ad647}{start\_address}} + (\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} * \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afe7fbedb30365ee050a210d4854a15b8}{PhysicalMemoryManager::s\_page\_size}}), \mbox{\hyperlink{namespaceMaxOS_1_1memory_ae0e83b5743a37b4d0d2a93bb3bbe84eba980a5bc5e6393398f4e52e1c27bdd382}{Present}} | \mbox{\hyperlink{namespaceMaxOS_1_1memory_ae0e83b5743a37b4d0d2a93bb3bbe84ebabc3cb78aef6a50841121fd08c2a49151}{Write}}, m\_pml4\_root\_address);}
\DoxyCodeLine{150 }
\DoxyCodeLine{151   \}}
\DoxyCodeLine{152 }
\DoxyCodeLine{153   \textcolor{comment}{// Return the address}}
\DoxyCodeLine{154   \textcolor{keywordflow}{return} (\textcolor{keywordtype}{void}*)chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa470b01af19e3aaeb7505cdd0b5ad647}{start\_address}};}
\DoxyCodeLine{155 \}}

\end{DoxyCode}


References address, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::align\+\_\+up\+\_\+to\+\_\+page(), Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::allocate\+\_\+frame(), A\+S\+S\+E\+RT, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::check\+\_\+aligned(), flags, Max\+O\+S\+::memory\+::\+Virtual\+Memory\+Chunk\+::flags, Max\+O\+S\+::drivers\+::peripherals\+::i, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::map(), Max\+O\+S\+::memory\+::\+Present, Max\+O\+S\+::memory\+::\+Reserve, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::s\+\_\+page\+\_\+size, size, Max\+O\+S\+::memory\+::\+Virtual\+Memory\+Chunk\+::size, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::size\+\_\+to\+\_\+frames(), Max\+O\+S\+::memory\+::\+Virtual\+Memory\+Chunk\+::start\+\_\+address, and Max\+O\+S\+::memory\+::\+Write.

\mbox{\Hypertarget{classMaxOS_1_1memory_1_1VirtualMemoryManager_a96b3efdb246def1b85d311a61e401af6}\label{classMaxOS_1_1memory_1_1VirtualMemoryManager_a96b3efdb246def1b85d311a61e401af6}} 
\index{MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}!free@{free}}
\index{free@{free}!MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}}
\doxysubsubsection{\texorpdfstring{free()}{free()}}
{\footnotesize\ttfamily void Virtual\+Memory\+Manager\+::free (\begin{DoxyParamCaption}\item[{void $\ast$}]{address }\end{DoxyParamCaption})}



Free a chunk of virtual memory. 


\begin{DoxyParams}{Parameters}
{\em address} & The address of the memory to free \\
\hline
\end{DoxyParams}


Definition at line 184 of file virtual.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{184                                              \{}
\DoxyCodeLine{185 }
\DoxyCodeLine{186   \textcolor{comment}{// Make sure freeing something}}
\DoxyCodeLine{187   \textcolor{keywordflow}{if}(\mbox{\hyperlink{amd__am79c973_8h_ac0d31ca829f934cccd89f8054e02773e}{address}} == \textcolor{keyword}{nullptr})}
\DoxyCodeLine{188     \textcolor{keywordflow}{return};}
\DoxyCodeLine{189 }
\DoxyCodeLine{190   \textcolor{comment}{// Find the chunk}}
\DoxyCodeLine{191   virtual\_memory\_region\_t* region = m\_first\_region;}
\DoxyCodeLine{192   \mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk}{virtual\_memory\_chunk\_t}}* chunk = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{193   \textcolor{keywordflow}{while}(region != \textcolor{keyword}{nullptr})\{}
\DoxyCodeLine{194 }
\DoxyCodeLine{195       \textcolor{comment}{// Loop through the chunks}}
\DoxyCodeLine{196       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} = 0; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} < s\_chunks\_per\_page; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}++)\{}
\DoxyCodeLine{197 }
\DoxyCodeLine{198         \textcolor{comment}{// Check if the address is in the chunk}}
\DoxyCodeLine{199         \textcolor{keywordflow}{if}(region-\/>chunks[\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}].start\_address == (uintptr\_t)\mbox{\hyperlink{amd__am79c973_8h_ac0d31ca829f934cccd89f8054e02773e}{address}})\{}
\DoxyCodeLine{200               chunk = \&region-\/>chunks[\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}];}
\DoxyCodeLine{201               \textcolor{keywordflow}{break};}
\DoxyCodeLine{202         \}}
\DoxyCodeLine{203       \}}
\DoxyCodeLine{204 }
\DoxyCodeLine{205       \textcolor{comment}{// If the chunk was found}}
\DoxyCodeLine{206       \textcolor{keywordflow}{if}(chunk != \textcolor{keyword}{nullptr})}
\DoxyCodeLine{207         \textcolor{keywordflow}{break};}
\DoxyCodeLine{208 }
\DoxyCodeLine{209       \textcolor{comment}{// Move to the next region}}
\DoxyCodeLine{210       region = region-\/>next;}
\DoxyCodeLine{211   \}}
\DoxyCodeLine{212 }
\DoxyCodeLine{213   \textcolor{comment}{// Make sure the chunk was found}}
\DoxyCodeLine{214   \textcolor{keywordflow}{if}(chunk == \textcolor{keyword}{nullptr})}
\DoxyCodeLine{215     \textcolor{keywordflow}{return};}
\DoxyCodeLine{216 }
\DoxyCodeLine{217   \textcolor{comment}{// Unmap the memory}}
\DoxyCodeLine{218   \textcolor{keywordtype}{size\_t} pages = \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_ad09e22d0fe86e952a3eb92718fcd3c32}{PhysicalMemoryManager::size\_to\_frames}}(chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa801ec740419740a3d9576bcdf821930}{size}});}
\DoxyCodeLine{219   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} = 0; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} < pages; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}++)\{}
\DoxyCodeLine{220 }
\DoxyCodeLine{221         \textcolor{comment}{// Unmap the frame}}
\DoxyCodeLine{222         m\_physical\_memory\_manager-\/>\mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_a47cc8d6c823f3c323f88e21437ba88ea}{unmap}}((\mbox{\hyperlink{namespaceMaxOS_1_1memory_a1a4a2cf740017bbb681bbe110a18fdcb}{virtual\_address\_t}}*)chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa470b01af19e3aaeb7505cdd0b5ad647}{start\_address}} + (\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} * \mbox{\hyperlink{classMaxOS_1_1memory_1_1PhysicalMemoryManager_afe7fbedb30365ee050a210d4854a15b8}{PhysicalMemoryManager::s\_page\_size}}), m\_pml4\_root\_address);}
\DoxyCodeLine{223 }
\DoxyCodeLine{224   \}}
\DoxyCodeLine{225 }
\DoxyCodeLine{226   \textcolor{comment}{// Clear the chunk}}
\DoxyCodeLine{227   chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa801ec740419740a3d9576bcdf821930}{size}} = 0;}
\DoxyCodeLine{228   chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_a3197fff13af0c0c20e83ad26c4e5d6f6}{flags}} = 0;}
\DoxyCodeLine{229   chunk-\/>\mbox{\hyperlink{structMaxOS_1_1memory_1_1VirtualMemoryChunk_aa470b01af19e3aaeb7505cdd0b5ad647}{start\_address}} = 0;}
\DoxyCodeLine{230 }
\DoxyCodeLine{231   \textcolor{comment}{// TODO: Some logic to use this space again}}
\DoxyCodeLine{232 \}}

\end{DoxyCode}


References address, Max\+O\+S\+::memory\+::\+Virtual\+Memory\+Chunk\+::flags, Max\+O\+S\+::drivers\+::peripherals\+::i, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::s\+\_\+page\+\_\+size, Max\+O\+S\+::memory\+::\+Virtual\+Memory\+Chunk\+::size, Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::size\+\_\+to\+\_\+frames(), Max\+O\+S\+::memory\+::\+Virtual\+Memory\+Chunk\+::start\+\_\+address, and Max\+O\+S\+::memory\+::\+Physical\+Memory\+Manager\+::unmap().

\mbox{\Hypertarget{classMaxOS_1_1memory_1_1VirtualMemoryManager_a4ae320422dd476cfbf63d810fc725bd5}\label{classMaxOS_1_1memory_1_1VirtualMemoryManager_a4ae320422dd476cfbf63d810fc725bd5}} 
\index{MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}!memory\_used@{memory\_used}}
\index{memory\_used@{memory\_used}!MaxOS::memory::VirtualMemoryManager@{MaxOS::memory::VirtualMemoryManager}}
\doxysubsubsection{\texorpdfstring{memory\_used()}{memory\_used()}}
{\footnotesize\ttfamily size\+\_\+t Virtual\+Memory\+Manager\+::memory\+\_\+used (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Returns the amount of memory used. 

\begin{DoxyReturn}{Returns}
The amount of memory used 
\end{DoxyReturn}


Definition at line 238 of file virtual.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{238                                          \{}
\DoxyCodeLine{239 }
\DoxyCodeLine{240   \textcolor{comment}{// Loop through all the regions and add up the size of the allocated chunks}}
\DoxyCodeLine{241   \textcolor{keywordtype}{size\_t} result = 0;}
\DoxyCodeLine{242 }
\DoxyCodeLine{243   \textcolor{comment}{// Iterate through the regions}}
\DoxyCodeLine{244   virtual\_memory\_region\_t *region = m\_first\_region;}
\DoxyCodeLine{245   \textcolor{keywordflow}{while} (region != \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{246 }
\DoxyCodeLine{247     \textcolor{comment}{// Loop through the chunks}}
\DoxyCodeLine{248     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} = 0; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}} < s\_chunks\_per\_page; \mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}++) \{}
\DoxyCodeLine{249 }
\DoxyCodeLine{250       \textcolor{comment}{// Check if the address is in the chunk}}
\DoxyCodeLine{251       \textcolor{keywordflow}{if} (region-\/>chunks[\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}].size != 0)}
\DoxyCodeLine{252         result += region-\/>chunks[\mbox{\hyperlink{namespaceMaxOS_1_1drivers_1_1peripherals_a891861cdf457ecedb7e3a5fa56515ebcaf552e09750e0ce71af8fc4fa0b32b8ff}{i}}].size;}
\DoxyCodeLine{253     \}}
\DoxyCodeLine{254 }
\DoxyCodeLine{255     \textcolor{comment}{// Move to the next region}}
\DoxyCodeLine{256     region = region-\/>next;}
\DoxyCodeLine{257   \}}
\DoxyCodeLine{258 }
\DoxyCodeLine{259   \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{260 \}}

\end{DoxyCode}


References Max\+O\+S\+::drivers\+::peripherals\+::i.



The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
/home/runner/work/\+Max\+O\+S/\+Max\+O\+S/kernel/include/memory/\mbox{\hyperlink{virtual_8h}{virtual.\+h}}\item 
/home/runner/work/\+Max\+O\+S/\+Max\+O\+S/kernel/src/memory/\mbox{\hyperlink{virtual_8cpp}{virtual.\+cpp}}\end{DoxyCompactItemize}
